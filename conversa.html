<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Transcri√ß√£o + Gatilhos robustos</title>
<style>
  :root { --bg1:#0f172a; --bg2:#0b1220; --card:#1e293b; --borda:#334155; --txt:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --danger:#ef4444; --toast:#111827; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px;display:flex;flex-direction:column;align-items:center;gap:16px}
  h1{margin:0;font-size:20px}
  .panel{width:92%;max-width:680px;background:var(--card);border:1px solid var(--borda);border-radius:12px;padding:14px 12px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
  button{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
  .start{background:var(--ok);color:#052e16}
  .stop{background:var(--danger);color:#fff}
  .clear{background:transparent;color:var(--txt);border:1px solid var(--borda)}
  .test{background:#3b82f6;color:#fff}
  label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
  .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  input[type="number"]{width:100%;padding:10px 12px;border-radius:10px;background:#0b1020;border:1px solid rgba(255,255,255,.12);color:var(--txt)}
  .chip{display:inline-flex;gap:6px;align-items:center;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
  .dot{width:8px;height:8px;border-radius:50%;background:#64748b}
  .dot.on{background:#10b981;box-shadow:0 0 0 4px rgba(16,185,129,.18)}
  #box{height:260px;background:#0b1020;border:1px dashed var(--borda);border-radius:10px;padding:10px;overflow-y:auto;white-space:pre-wrap;line-height:1.45}
  #debug{font-size:12px;color:#cbd5e1;background:#0b1020;border:1px dashed var(--borda);border-radius:10px;padding:10px;display:none;white-space:pre-wrap}
  #toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:999999}
  @media (max-width:540px){ #toasts{right:50%;transform:translateX(50%);} }
  .toast{background:#111827;border:1px solid rgba(255,255,255,.12);border-left:5px solid #22c55e;color:#e5e7eb;
         padding:12px 14px;border-radius:10px;max-width:92vw;width:320px;opacity:0;transform:translateY(6px) scale(.98);animation:pop .2s ease-out forwards}
  .toast h4{margin:0 0 4px 0;font-size:14px} .toast p{margin:0;font-size:13px;color:#d1d5db}
  @keyframes pop{to{opacity:1;transform:translateY(0) scale(1)}}
</style>
</head>
<body>
  <h1>üéôÔ∏è Transcri√ß√£o + Gatilhos robustos (sem API)</h1>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="buttons">
        <button class="start" id="btnStart">Iniciar</button>
        <button class="stop" id="btnStop">Parar</button>
        <button class="clear" id="btnClear">Limpar</button>
        <button class="test" id="btnTest">Testar toast</button>
      </div>
      <span class="chip"><span id="dot" class="dot"></span><span id="status">Parado</span></span>
    </div>

    <div class="controls">
      <div>
        <label for="cooldown">Cooldown por palavra (segundos)</label>
        <input id="cooldown" type="number" min="0" step="0.5" value="4" />
      </div>
      <div class="row" style="gap:12px">
        <label style="margin:0"><input type="checkbox" id="partialOn" checked> Disparar tamb√©m em parcial (debounce)</label>
        <label style="margin:0"><input type="checkbox" id="showDebug"> Mostrar debug</label>
      </div>
    </div>

    <label style="margin-top:6px">Transcri√ß√£o</label>
    <div id="box"></div>

    <label style="margin-top:8px">Debug</label>
    <div id="debug"></div>

    <label style="margin-top:10px">Palavras-chave:</label>
    <div style="font-size:12px;color:var(--muted)">
      cliente(s), investimento(s)/investir, cart√£o/cart√µes, cr√©dito(s)/empr√©stimo(s), seguro(s)
    </div>
  </div>

  <div id="toasts"></div>

<script>
  // ========= Util/UI =========
  const $ = s => document.querySelector(s);
  const box = $("#box"), debug = $("#debug"), dot = $("#dot"), statusTxt = $("#status"), toasts = $("#toasts");
  function setStatus(on){ if(on){dot.classList.add("on"); statusTxt.textContent="Gravando";} else {dot.classList.remove("on"); statusTxt.textContent="Parado";} }
  function showToast(title, body){
    const el = document.createElement('div');
    el.className = 'toast';
    el.innerHTML = `<h4>${title}</h4><p>${body}</p>`;
    toasts.appendChild(el);
    setTimeout(()=>{ el.style.opacity=.0; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(), 300); }, 4500);
  }
  $("#btnTest").onclick = ()=> showToast('‚úÖ Toast OK', 'O componente de notifica√ß√£o est√° funcionando.');

  // ========= Normaliza√ß√£o (remove acentos, min√∫sculas) =========
  function normalize(s){
    return (s||"")
      .toLowerCase()
      .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // remove diacr√≠ticos
  }

  // ========= Gatilhos (arrays de sin√¥nimos) =========
  const triggers = [
    { words:['cliente','clientes'], tip:'Use pergunta aberta para confirmar necessidade antes da oferta.' },
    { words:['investimento','investimentos','investir'], tip:'Pergunte prazo, liquidez e objetivo para encaixar o produto certo.' },
    { words:['cartao','cartoes','cart√£o','cart√µes'], tip:'Cheque limites, anuidade e benef√≠cios antes de oferecer upgrade.' },
    { words:['credito','creditos','emprestimo','emprestimos'], tip:'Valide renda, parcelas e seguros; fa√ßa simula√ß√£o consultiva.' },
    { words:['seguro','seguros'], tip:'Gancho de prote√ß√£o familiar e eventos imprevistos.' }
  ];

  // Cooldown por palavra
  const lastByWord = new Map();
  function runTriggers(text){
    const cdMs = Math.max(0, Number($("#cooldown").value||4) * 1000);
    const now = Date.now();
    const norm = normalize(text);
    const tokens = norm.split(/[^a-z0-9]+/).filter(Boolean); // quebra por n√£o alfa-num
    const joined = ' ' + tokens.join(' ') + ' '; // ajuda a simular bordas de palavra

    // Mostra debug opcional
    if($("#showDebug").checked){
      debug.style.display = 'block';
      debug.textContent =
        "Original: " + text + "\n" +
        "Normalizado: " + norm + "\n" +
        "Tokens: " + tokens.join(', ');
    } else {
      debug.style.display = 'none';
      debug.textContent = '';
    }

    // Procura por qualquer palavra de cada conjunto
    for(const t of triggers){
      for(const w of t.words){
        const needle = ' ' + w + ' ';
        if(joined.includes(needle)){
          const last = lastByWord.get(w) || 0;
          if(now - last > cdMs){
            showToast('üí° Insight', t.tip);
            lastByWord.set(w, now);
          }
          return; // dispara s√≥ um por vez
        }
      }
    }
  }

  // ========= Transcri√ß√£o =========
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition = null, listening = false, partialTimer = null;

  function setupRec(){
    if(!SR){
      box.textContent = "Web Speech API n√£o suportada (use Chrome desktop/Android).";
      return null;
    }
    const rec = new SR();
    rec.lang = 'pt-BR';
    rec.continuous = true;
    rec.interimResults = true;

    rec.onstart = ()=>{ listening=true; setStatus(true); };
    rec.onend   = ()=>{ listening=false; setStatus(false); };
    rec.onerror = (e)=>{ appendLine(`[Erro]: ${e.error || 'desconhecido'}`); };

    rec.onresult = (ev)=>{
      let parcial = '';
      for(let i=ev.resultIndex;i<ev.results.length;i++){
        const r = ev.results[i];
        const t = (r[0] && r[0].transcript) ? r[0].transcript : '';
        if(r.isFinal){
          const phrase = t.trim();
          if(phrase){
            appendLine(phrase);
            runTriggers(phrase); // FINAL
          }
        } else {
          parcial = t;
        }
      }
      if(parcial){
        showPartial(parcial);
        if($("#partialOn").checked){
          if(partialTimer) clearTimeout(partialTimer);
          partialTimer = setTimeout(()=> runTriggers(parcial), 650); // PARCIAL (debounce)
        }
      }
    };
    return rec;
  }

  function appendLine(text){
    if(!text) return;
    const cur = box.textContent;
    const sep = cur && !cur.endsWith('\n') ? '\n' : '';
    box.textContent = (cur||'') + sep + text + '\n';
    box.scrollTop = box.scrollHeight;
  }
  function showPartial(parcial){
    const lines = box.textContent.split('\n');
    if(lines[lines.length-1]?.trim()==='') lines.pop();
    const base = lines.join('\n');
    box.textContent = (base ? base+'\n' : '') + parcial;
    box.scrollTop = box.scrollHeight;
  }

  // ========= Controles =========
  $("#btnStart").onclick = ()=>{
    if(listening) return;
    if(!recognition) recognition = setupRec();
    if(recognition){ try{ recognition.start(); }catch{} }
  };
  $("#btnStop").onclick = ()=>{
    if(!listening || !recognition) return;
    try{ recognition.stop(); }catch{}
  };
  $("#btnClear").onclick = ()=>{ box.textContent = ""; debug.textContent=""; };
</script>
</body>
</html>