<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Transcri√ß√£o + Insights (Teste R√°pido)</title>
<style>
  :root { --bg:#0f172a; --card:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#22c55e; --warn:#f59e0b; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b1220,#0e1526);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--text)}
  header{padding:20px 16px;border-bottom:1px solid rgba(255,255,255,.06)}
  h1{margin:0;font-size:20px;font-weight:700;letter-spacing:.2px}
  .wrap{max-width:960px;margin:24px auto;padding:0 16px;display:grid;gap:16px}
  .row{display:grid;grid-template-columns:1fr;gap:12px}
  @media(min-width:860px){.row{grid-template-columns:2fr 1fr}}
  .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:14px 16px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;background:#0b1020;border:1px solid rgba(255,255,255,.12);color:var(--text);outline:none}
  textarea{min-height:86px;resize:vertical}
  .btns{display:flex;gap:10px;flex-wrap:wrap}
  button{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:600;cursor:pointer}
  .solid{background:var(--accent);color:#052e16}
  .ghost{background:transparent;color:var(--text);border:1px solid rgba(255,255,255,.18)}
  .danger{background:#ef4444;color:#fff}
  .muted{color:var(--muted);font-size:12px}
  .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
  #statusDot{width:8px;height:8px;border-radius:50%;background:#888;display:inline-block}
  #statusDot.on{background:#10b981;box-shadow:0 0 0 4px rgba(16,185,129,.18)}
  #transcricao{min-height:180px;white-space:pre-wrap;line-height:1.4;background:#0b1020;border:1px dashed rgba(255,255,255,.15);padding:12px;border-radius:10px}
  #log{min-height:120px;background:#0b1020;border:1px dashed rgba(255,255,255,.15);padding:12px;border-radius:10px;font-size:12px;color:#cbd5e1;overflow:auto;max-height:220px}
  /* Notifica√ß√µes */
  .toast{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:9999}
  .note{background:#111827;border:1px solid rgba(255,255,255,.12);border-left:5px solid var(--accent);
        color:#e5e7eb;border-radius:10px;padding:12px 14px;max-width:320px;opacity:0;transform:translateY(8px) scale(.98);
        animation:pop .2s ease-out forwards}
  .note.warn{border-left-color:var(--warn)}
  .note h4{margin:0 0 4px 0;font-size:14px}
  .note p{margin:0;font-size:13px;color:#cfd8e3}
  @keyframes pop{to{opacity:1;transform:translateY(0) scale(1)}}
  .blink{animation:blink 1s steps(2,start) 2}
  @keyframes blink{to{visibility:hidden}}
  code.inline{background:#0b1020;border:1px solid rgba(255,255,255,.12);padding:2px 6px;border-radius:6px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas}
</style>
</head>
<body>
<header>
  <h1>üéôÔ∏è Transcri√ß√£o + Insights em tempo real <span class="pill"><span id="statusDot"></span> <span id="statusText">Parado</span></span></h1>
</header>

<div class="wrap">
  <div class="row">
    <!-- Coluna esquerda -->
    <div class="card">
      <div class="btns" style="margin-bottom:10px">
        <button id="btnStart" class="solid">Iniciar</button>
        <button id="btnStop" class="ghost">Parar</button>
        <button id="btnClear" class="ghost">Limpar</button>
      </div>

      <div style="display:grid;gap:10px;margin-bottom:12px">
        <div class="pill">Idioma da transcri√ß√£o: <strong style="margin-left:6px">pt-BR</strong></div>
        <div class="muted">Dica: fale frases completas. O envio para a IA ocorre quando a frase √© detectada como <em>final</em> pela API de voz.</div>
      </div>

      <label>Transcri√ß√£o (ao vivo)</label>
      <div id="transcricao"></div>
    </div>

    <!-- Coluna direita -->
    <div class="card">
      <label for="apiKey">OpenAI API Key (teste r√°pido ‚Äî inseguro no front-end)</label>
      <input id="apiKey" type="password" placeholder="sk-..." autocomplete="off" />

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px">
        <div>
          <label for="model">Modelo</label>
          <select id="model">
            <option value="gpt-4o-mini" selected>gpt-4o-mini (r√°pido/econ.)</option>
            <option value="gpt-4o">gpt-4o</option>
            <option value="gpt-4.1-mini">gpt-4.1-mini</option>
            <option value="gpt-4.1">gpt-4.1</option>
          </select>
        </div>
        <div>
          <label for="cooldown">Cooldown (seg) entre chamadas</label>
          <input id="cooldown" type="number" min="0" step="0.5" value="2" />
        </div>
      </div>

      <label style="margin-top:10px">Prompt do analista (pode editar)</label>
      <textarea id="systemPrompt">Voc√™ √© um assistente de vendas em tempo real.
Receba trechos de fala do atendente (portugu√™s do Brasil) e devolva um insight curto que ajude a conversa a avan√ßar.
Regras:
- M√°x. 160 caracteres.
- Seja espec√≠fico e acion√°vel (perguntas, obje√ß√µes, pr√≥ximos passos).
- Se n√£o houver contexto √∫til, responda: "Sem insight agora".</textarea>

      <label style="margin-top:10px">Log</label>
      <div id="log"></div>
      <div class="muted" style="margin-top:8px">Sem backend? Ainda assim voc√™ ter√° <strong>gatilhos locais</strong> (palavras-chave) gerando notifica√ß√µes instant√¢neas.</div>
    </div>
  </div>
</div>

<!-- Notifica√ß√µes -->
<div class="toast" id="toast"></div>

<script>
/* ================== Utilidades UI ================== */
const $ = (sel)=>document.querySelector(sel);
const logEl = $("#log"), transEl = $("#transcricao"), toast = $("#toast"), dot = $("#statusDot"), stxt = $("#statusText");
function log(line){ const time=new Date().toLocaleTimeString(); logEl.innerText = `[${time}] ${line}\n` + logEl.innerText; }
function setStatus(on){ if(on){dot.classList.add('on'); stxt.textContent="Gravando";} else {dot.classList.remove('on'); stxt.textContent="Parado";}}
function toastNote(title, body, kind="ok"){
  const n = document.createElement("div");
  n.className = "note blink" + (kind==="warn" ? " warn" : "");
  n.innerHTML = `<h4>${title}</h4><p>${body}</p>`;
  toast.appendChild(n);
  setTimeout(()=>{ n.style.opacity=.0; n.style.transform='translateY(6px)'; setTimeout(()=>n.remove(), 300); }, 4800);
}

/* ================== Web Speech API (Chrome) ================== */
let recognition = null;
let listening = false;
let lastFinalSentAt = 0;
let cooldownMs = 2000;
let pendingBuffer = ""; // mostra texto parcial

function setupRecognition(){
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SR){
    toastNote("Microfone", "Seu navegador n√£o suporta Web Speech API. Use Chrome desktop.", "warn");
    log("Web Speech API n√£o suportada.");
    return null;
  }
  const rec = new SR();
  rec.lang = "pt-BR";
  rec.continuous = true;
  rec.interimResults = true;

  rec.onstart = ()=>{ listening = true; setStatus(true); log("Transcri√ß√£o iniciada."); };
  rec.onend   = ()=>{ listening = false; setStatus(false); log("Transcri√ß√£o parada."); };

  rec.onerror = (e)=>{ log("Erro de transcri√ß√£o: "+ (e.error||"desconhecido")); toastNote("Transcri√ß√£o", "Erro: " + e.error, "warn"); };

  rec.onresult = (event)=>{
    let liveText = pendingBuffer;
    for(let i=event.resultIndex; i<event.results.length; i++){
      const r = event.results[i];
      const t = r[0]?.transcript || "";
      if(r.isFinal){
        const phrase = t.trim();
        if(phrase){
          showLive(phrase, true);
          processPhrase(phrase);
        }
      }else{
        liveText = t;
      }
    }
    if(liveText) showLive(liveText, false);
  };

  return rec;
}

function showLive(text, isFinal){
  if(isFinal){
    transEl.innerText += (transEl.innerText.endsWith("\n")||transEl.innerText==="") ? text+"\n" : " "+text+"\n";
    pendingBuffer = "";
  }else{
    pendingBuffer = text;
    // Render parcial: √∫ltima linha substitu√≠da
    const lines = transEl.innerText.split("\n");
    if(lines[lines.length-1].trim()==="") lines.pop();
    const base = lines.join("\n");
    transEl.innerText = (base ? base+"\n" : "") + text;
  }
}

/* ================== Gatilhos locais (fallback offline) ================== */
const localTriggers = [
  {kw:/\b(cart(√£|a)o|cartao|cart√£o|cart√µes)\b/i, tip:"Cheque limites, anuidade e benef√≠cios antes de oferecer upgrade."},
  {kw:/\b(invest(imento|ir|e))\b/i, tip:"Pergunte prazo, liquidez e objetivo para encaixar o produto certo."},
  {kw:/\b(credito|cr√©dito|empr(√©|e)stimo)\b/i, tip:"Valide renda, parcelas e seguros; ofere√ßa simula√ß√£o consultiva."},
  {kw:/\b(seguro(s)?)\b/i, tip:"Puxe gancho de prote√ß√£o familiar e custos imprevistos."},
  {kw:/\b(cliente|senhor|senhora|voc(√™|e))\b/i, tip:"Confirme necessidade com pergunta aberta antes da oferta."}
];

function runLocalTriggers(phrase){
  for(const t of localTriggers){
    if(t.kw.test(phrase)){
      toastNote("üí° Insight r√°pido", t.tip);
      break;
    }
  }
}

/* ================== OpenAI ================== */
async function askOpenAI(phrase){
  const apiKey = $("#apiKey").value.trim();
  if(!apiKey){ log("Sem API Key ‚Äî usando apenas gatilhos locais."); return null; }
  const model = $("#model").value;
  const system = $("#systemPrompt").value;

  try{
    const res = await fetch("https://api.openai.com/v1/chat/completions",{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "Authorization":`Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model,
        temperature: 0.4,
        messages: [
          {role:"system", content: system},
          {role:"user", content: `Trecho do atendente: "${phrase}"\nProduza 1 insight curto.`}
        ]
      })
    });
    if(!res.ok){
      const errTxt = await res.text();
      throw new Error(`HTTP ${res.status}: ${errTxt}`);
    }
    const data = await res.json();
    const tip = data?.choices?.[0]?.message?.content?.trim() || "";
    return tip || null;
  }catch(err){
    log("Falha ao chamar OpenAI: " + err.message);
    toastNote("OpenAI", "Erro ao gerar insight (veja o log).", "warn");
    return null;
  }
}

/* ================== Orquestra√ß√£o ================== */
async function processPhrase(phrase){
  const now = Date.now();
  cooldownMs = Math.max(0, Number($("#cooldown").value||2)*1000);
  runLocalTriggers(phrase);

  if(now - lastFinalSentAt < cooldownMs){
    log("Cooldown ativo ‚Äî pulando chamada √† IA.");
    return;
  }
  lastFinalSentAt = now;

  log('Enviando para IA: "'+phrase+'"');
  const tip = await askOpenAI(phrase);
  if(tip && tip.toLowerCase()!=="sem insight agora"){
    toastNote("ü§ñ Insight da IA", tip);
    log("Insight: " + tip);
  }else{
    log("IA: sem insight agora.");
  }
}

/* ================== Controles ================== */
$("#btnStart").addEventListener("click", ()=>{
  if(listening) return;
  if(!recognition) recognition = setupRecognition();
  if(recognition){
    try{ recognition.start(); }catch(e){ /* Chrome pode lan√ßar se j√° estiver em start */ }
  }
});
$("#btnStop").addEventListener("click", ()=>{
  if(!listening || !recognition) return;
  try{ recognition.stop(); }catch(e){}
});
$("#btnClear").addEventListener("click", ()=>{
  transEl.innerText = "";
  logEl.innerText = "";
});

/* Info inicial */
log("Pronto para testar. Clique em Iniciar, fale frases completas.");
log("Para testar sem API, use palavras como 'cliente', 'investimento', 'cart√£o' e veja as notifica√ß√µes.");
</script>
</body>
</html>