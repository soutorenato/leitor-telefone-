<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transcri√ß√£o + Toast (teste)</title>
  <style>
    :root { --bg1:#0f172a; --bg2:#0b1220; --card:#1e293b; --borda:#334155; --txt:#e5e7eb; --muted:#94a3b8; --ok:#22c55e; --danger:#ef4444; --toast:#111827; }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--txt);
         font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding:20px;display:flex;flex-direction:column;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    .panel{width:92%;max-width:640px;background:var(--card);border:1px solid var(--borda);border-radius:12px;padding:14px 12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .buttons{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    button{appearance:none;border:0;padding:10px 14px;border-radius:10px;font-weight:700;cursor:pointer}
    .start{background:var(--ok);color:#052e16}
    .stop{background:var(--danger);color:#fff}
    .clear{background:transparent;color:var(--txt);border:1px solid var(--borda)}
    .test{background:#3b82f6;color:#fff}
    .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:6px 10px;border-radius:999px}
    .dot{width:8px;height:8px;border-radius:50%;background:#64748b}
    .dot.on{background:#10b981;box-shadow:0 0 0 4px rgba(16,185,129,.18)}
    label{display:block;font-size:12px;color:var(--muted);margin:6px 0}
    #box{height:260px;background:#0b1020;border:1px dashed var(--borda);border-radius:10px;padding:10px;overflow-y:auto;white-space:pre-wrap;line-height:1.45}
    #last{font-size:12px;color:#cbd5e1}
    .toasts{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:9999}
    @media (max-width:540px){ .toasts{right:50%;transform:translateX(50%);} }
    .toast{background:var(--toast);border:1px solid rgba(255,255,255,.12);border-left:5px solid var(--ok);color:var(--txt);
           padding:12px 14px;border-radius:10px;max-width:92vw;width:320px;opacity:0;transform:translateY(6px) scale(.98);animation:pop .2s ease-out forwards}
    .toast h4{margin:0 0 4px 0;font-size:14px}
    .toast p{margin:0;font-size:13px;color:#d1d5db}
    @keyframes pop{to{opacity:1;transform:translateY(0) scale(1)}}
    .blink{animation:blink 1s steps(2,start) 2}
    @keyframes blink{to{visibility:hidden}}
  </style>
</head>
<body>
  <h1>üéôÔ∏è Transcri√ß√£o com Toast (sem API)</h1>

  <div class="panel">
    <div class="row" style="justify-content:space-between">
      <div class="buttons">
        <button class="start" id="btnStart">Iniciar</button>
        <button class="stop" id="btnStop">Parar</button>
        <button class="clear" id="btnClear">Limpar</button>
        <button class="test" id="btnTest">Testar toast</button>
      </div>
      <span class="pill"><span id="dot" class="dot"></span><span id="status">Parado</span></span>
    </div>

    <div class="row" id="supportRow"></div>

    <label>Transcri√ß√£o</label>
    <div id="box"></div>
    <div id="last">√öltima frase final: <em>(aguardando)</em></div>

    <label style="margin-top:10px">Palavras-chave que disparam toasts:</label>
    <div style="font-size:12px;color:var(--muted)">
      <code>cliente</code>, <code>investimento</code>, <code>cart√£o</code>, <code>cr√©dito</code>, <code>seguro</code>
      <br/>Dica: fa√ßa uma pequena pausa para gerar <em>resultado final</em>. Nesta vers√£o, tamb√©m disparamos em parcial (com debounce).
    </div>
  </div>

  <div class="toasts" id="toasts"></div>

  <script>
    // ====== UI util ======
    const $ = s => document.querySelector(s);
    const box = $("#box"), dot = $("#dot"), statusTxt = $("#status"), toasts = $("#toasts"), lastEl = $("#last");
    function setStatus(on){ if(on){dot.classList.add("on"); statusTxt.textContent="Gravando";} else {dot.classList.remove("on"); statusTxt.textContent="Parado";} }
    function toast(title, body){
      const el=document.createElement("div");
      el.className="toast blink";
      el.innerHTML=`<h4>${title}</h4><p>${body}</p>`;
      toasts.appendChild(el);
      setTimeout(()=>{ el.style.opacity=.0; el.style.transform='translateY(6px)'; setTimeout(()=>el.remove(),300); }, 4500);
    }
    $("#btnTest").onclick = ()=> toast("üîî Teste", "Se voc√™ est√° vendo isto, os toasts est√£o funcionando.");

    // ====== Suporte do navegador ======
    const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
    const supported = !!SR;
    const supportRow = $("#supportRow");
    supportRow.innerHTML = supported
      ? `<span class="pill">Web Speech API: <strong>suportado</strong></span>`
      : `<span class="pill" style="border-color:#f59e0b">Web Speech API: <strong style="color:#f59e0b">N√ÉO suportado (use Chrome desktop/Android)</strong></span>`;
    if (!supported) { $("#btnStart").disabled = true; }

    // ====== Reconhecimento ======
    let recognition = null, listening = false, partialDebounceTimer = null;

    function setupRecognition(){
      if(!supported) return null;
      const rec = new SR();
      rec.lang = "pt-BR";
      rec.continuous = true;
      rec.interimResults = true;

      rec.onstart = ()=>{ listening=true; setStatus(true); };
      rec.onend   = ()=>{ listening=false; setStatus(false); };

      rec.onerror = (e)=>{ appendLine(`[Erro]: ${e.error || "desconhecido"}`); };

      rec.onresult = (ev)=>{
        // Vamos capturar tanto finais quanto parciais
        let partial = "";
        for(let i=ev.resultIndex; i<ev.results.length; i++){
          const r = ev.results[i];
          const t = (r[0] && r[0].transcript) ? r[0].transcript : "";
          if(r.isFinal){
            const phrase = t.trim();
            if(phrase){
              appendLine(phrase);
              lastEl.innerHTML = "√öltima frase final: <strong>"+escapeHtml(phrase)+"</strong>";
              runTriggers(phrase);      // dispara em final
            }
          } else {
            partial = t;
          }
        }
        if(partial){
          showPartial(partial);
          // dispara triggers tamb√©m em parcial, com debounce para n√£o spammar
          if(partialDebounceTimer) clearTimeout(partialDebounceTimer);
          partialDebounceTimer = setTimeout(()=> runTriggers(partial), 700);
        }
      };
      return rec;
    }

    // ====== √Årea fixa com rolagem interna ======
    function appendLine(text){
      if(!text) return;
      const cur = box.textContent;
      const sep = cur && !cur.endsWith("\n") ? "\n" : "";
      box.textContent = (cur||"") + sep + text + "\n";
      box.scrollTop = box.scrollHeight;
    }
    function showPartial(parcial){
      const lines = box.textContent.split("\n");
      if(lines[lines.length-1].trim()==="") lines.pop();
      const base = lines.join("\n");
      box.textContent = (base ? base+"\n" : "") + parcial;
      box.scrollTop = box.scrollHeight;
    }
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m])); }

    // ====== Gatilhos (regex robustas) + cooldown ======
    const triggers = [
      { re:/\b(cart(√£|a)o|cartao|cart√£o|cart√µes)\b/i, tip:"Cheque limites, anuidade e benef√≠cios antes de oferecer upgrade." },
      { re:/\b(invest(imento|ir|e)s?)\b/i,           tip:"Pergunte prazo, liquidez e objetivo para encaixar o produto certo." },
      { re:/\b(cr[e√©]dito(s)?|empr[e√©]stimo(s)?)\b/i,tip:"Valide renda, parcelas e seguros; fa√ßa simula√ß√£o consultiva." },
      { re:/\b(seguro(s)?)\b/i,                      tip:"Gancho de prote√ß√£o familiar e eventos imprevistos." },
      { re:/\b(cliente(s)?|senhor(a)?|voc[√™e])\b/i,  tip:"Use pergunta aberta para confirmar necessidade antes da oferta." }
    ];
    const lastToastAt = new Map();
    const COOLDOWN_MS = 4000;

    function runTriggers(text){
      const now = Date.now();
      const lower = text.toLowerCase();
      for(let i=0;i<triggers.length;i++){
        const t = triggers[i];
        if(t.re.test(lower)){
          const last = lastToastAt.get(i) || 0;
          if(now - last > COOLDOWN_MS){
            toast("üí° Insight", t.tip);
            lastToastAt.set(i, now);
          }
          break; // apenas um por trecho
        }
      }
    }

    // ====== Controles ======
    $("#btnStart").onclick = ()=>{
      if(listening) return;
      if(!recognition) recognition = setupRecognition();
      if(recognition){
        try{ recognition.start(); }catch{}
      }
    };
    $("#btnStop").onclick = ()=>{
      if(!listening || !recognition) return;
      try{ recognition.stop(); }catch{}
    };
    $("#btnClear").onclick = ()=>{ box.textContent = ""; lastEl.innerHTML = "√öltima frase final: <em>(aguardando)</em>"; };
  </script>
</body>
</html>