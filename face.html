<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reconhecimento Facial (client-side)</title>
  <style>
    :root { --bg:#0f1220; --card:#171b2e; --text:#e9ecf1; --muted:#9aa3b2; --accent:#5aa8ff; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:18px 20px;border-bottom:1px solid #22263d;display:flex;justify-content:space-between;align-items:center}
    h1{margin:0;font-size:18px}
    main{display:grid;grid-template-columns:1fr 380px;gap:16px;padding:16px}
    @media (max-width: 980px){ main{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid #22263d;border-radius:12px; padding:14px}
    .stack{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    input[type="text"]{width:100%;background:#0e1121;border:1px solid #2a2f4a;color:var(--text);border-radius:8px;padding:10px}
    button{background:#1e2440;border:1px solid #2a2f4a;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
    button.primary{background:var(--accent);border-color:#3f86d6;color:#081321;font-weight:600}
    button:disabled{opacity:.55;cursor:not-allowed}
    small{color:var(--muted)}
    .pill{display:inline-block;font-size:12px;padding:4px 8px;border:1px solid #2a2f4a;border-radius:999px;color:var(--muted)}
    .video-wrap{position:relative; border-radius:12px; overflow:hidden; background:#0c0f1f; aspect-ratio:16/9}
    video,canvas{position:absolute; inset:0; width:100%; height:100%; object-fit:cover}
    .log{max-height:160px; overflow:auto; background:#0e1121; border:1px solid #2a2f4a; border-radius:8px; padding:8px; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#cfd6e6; white-space:pre-wrap}
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .tag{background:#0e1121;border:1px solid #2a2f4a;border-radius:8px;padding:6px 8px;color:#cfd6e6;font-size:12px}
    .danger{color:#ff7070}
  </style>
</head>
<body>
  <header>
    <h1>Reconhecimento Facial (demo 1 local)</h1>
    <span class="pill" id="status">Preparando…</span>
  </header>

  <main>
    <section class="card">
      <div class="video-wrap">
        <video id="video" autoplay muted playsinline></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="stack">
          <button id="btnStart" class="primary" disabled>Iniciar câmera</button>
          <button id="btnStop" disabled>Parar câmera</button>
          <span class="tag" id="camInfo">Câmera parada</span>
        </div>
        <div class="stack">
          <span class="tag" id="facesCount">0 rosto(s)</span>
          <span class="tag" id="fps">FPS: —</span>
        </div>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="stack">
          <input id="nameInput" class="grow" type="text" placeholder="Nome para cadastro (ex.: Renato)" disabled />
          <button id="btnEnroll" disabled>Cadastrar rosto</button>
          <button id="btnRecognize" class="primary" disabled>Reconhecer</button>
          <button id="btnIdle" disabled>Parar</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <small>Estado: <strong id="mode">IDLE</strong> • Threshold: <span id="threshVal">0.6</span> (menor = mais exigente)</small>
        <input id="thresh" type="range" min="0.35" max="0.8" step="0.01" value="0.6" style="width:100%" disabled>
      </div>
    </section>

    <aside class="card">
      <h3 style="margin:6px 0 8px">Base de rostos</h3>
      <div class="row">
        <div class="stack">
          <button id="btnExport" disabled>Baixar JSON</button>
          <label>
            <input id="fileImport" type="file" accept="application/json" style="display:none">
            <button id="btnImport" disabled>Importar JSON</button>
          </label>
        </div>
        <button id="btnClear" class="danger" disabled>Apagar Base</button>
      </div>
      <div style="margin-top:10px">
        <small id="dbInfo">Nenhum rosto cadastrado.</small>
      </div>

      <h3 style="margin:14px 0 8px">Log</h3>
      <div class="log" id="log"></div>

      <h3 style="margin:14px 0 8px">Dicas</h3>
      <ul style="margin:0 0 0 18px; padding:0">
        <li>Cadastre 3–5 amostras por pessoa (ângulos/expressões diferentes).</li>
        <li>Ambiente bem iluminado melhora MUITO o resultado.</li>
        <li>Se aparecer “unknown”, ajuste o threshold ou adicione mais amostras.</li>
      </ul>
    </aside>
  </main>

  <!-- Boot robusto: carrega face-api.js, espera modelos e só então ativa a app -->
  <script>
  (async () => {
    const $ = s => document.querySelector(s);
    const statusEl = $('#status');
    const logEl = $('#log');
    const enable = (ids, v=true)=> ids.forEach(id => { const el=$(id); if(el) el.disabled = !v; });
    function log(msg){ const t=new Date().toLocaleTimeString(); logEl.textContent = `[${t}] ${msg}\n` + logEl.textContent; }

    // 1) Espera DOM
    await new Promise(r => {
      if (document.readyState === 'complete' || document.readyState === 'interactive') return r();
      document.addEventListener('DOMContentLoaded', r, { once: true });
    });

    // 2) Carrega face-api.js (com fallback)
    async function loadScriptOnce() {
      if (window.faceapi) return;
      const trySrc = async (src) => new Promise((res, rej) => {
        const s = document.createElement('script');
        s.src = src;
        s.async = false;            // garante ordem no Safari/iOS
        s.crossOrigin = "anonymous";
        s.onload = () => res();
        s.onerror = () => rej();
        document.head.appendChild(s);
      });
      try {
        await trySrc("https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js");
      } catch {
        await trySrc("https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js");
      }
    }

    try {
      statusEl.textContent = 'Carregando biblioteca…';
      await loadScriptOnce();
      if (!window.faceapi) throw new Error('face-api.js não disponível');
      statusEl.textContent = 'Carregando modelos…';
      const WEIGHTS = "https://unpkg.com/face-api.js@0.22.2/weights";
      await faceapi.nets.tinyFaceDetector.loadFromUri(WEIGHTS);
      await faceapi.nets.faceLandmark68Net.loadFromUri(WEIGHTS);
      await faceapi.nets.faceRecognitionNet.loadFromUri(WEIGHTS);
      statusEl.textContent = 'Modelos prontos';
      log('Biblioteca e modelos carregados.');
    } catch(e) {
      statusEl.textContent = 'Erro ao carregar modelos';
      log('Erro modelos: ' + (e.message || e));
      alert('Falha ao carregar a biblioteca/modelos. Verifique a conexão/HTTPS.');
      return;
    }

    // 3) App (só roda se modelos prontos)
    // ---------- Estado/UI ----------
    enable(['#btnStart','#btnStop','#btnEnroll','#btnRecognize','#btnIdle','#thresh',
            '#btnExport','#btnImport','#btnClear','#nameInput'], true);

    const video   = $('#video');
    const canvas  = $('#overlay');
    const ctx     = canvas.getContext('2d');
    const facesCount = $('#facesCount');
    const fpsEl   = $('#fps');
    const camInfo = $('#camInfo');
    const modeEl  = $('#mode');
    const dbInfo  = $('#dbInfo');
    const nameInput = $('#nameInput');
    const thresh = $('#thresh');
    const threshVal = $('#threshVal');

    let stream=null, detections=[], lastTime=performance.now(), rafId=null;
    let mode='IDLE'; let matcher=null;

    const loadDB = ()=> { try{ return JSON.parse(localStorage.getItem('face-db')||'[]'); }catch(e){ return []; } };
    const saveDB = (db)=> { localStorage.setItem('face-db', JSON.stringify(db)); updateDbInfo(); };
    const updateDbInfo = ()=> {
      const db = loadDB();
      const total = db.reduce((a,p)=>a+p.descriptors.length,0);
      dbInfo.textContent = db.length ? `${db.length} pessoa(s), ${total} amostras` : 'Nenhum rosto cadastrado.';
    };
    updateDbInfo();

    function buildMatcher(){
      const db = loadDB();
      const labeled = db.map(entry => new faceapi.LabeledFaceDescriptors(
        entry.label, entry.descriptors.map(d => new Float32Array(d))
      ));
      matcher = labeled.length ? new faceapi.FaceMatcher(labeled, parseFloat(thresh.value)) : null;
      log('Matcher atualizado: ' + (matcher ? `${db.length} pessoa(s)` : 'vazio'));
    }
    buildMatcher();

    thresh.addEventListener('input', ()=>{ threshVal.textContent = thresh.value; buildMatcher(); });

    function resizeCanvas(){
      const w = video.videoWidth, h = video.videoHeight;
      if (!w || !h) return;
      canvas.width = w; canvas.height = h;
    }

    async function startCamera(){
      try{
        stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:'user' }, audio:false });
        video.srcObject = stream; await video.play();
        camInfo.textContent = 'Câmera ligada'; log('Câmera iniciada.'); resizeCanvas(); tick();
      }catch(e){ camInfo.textContent = 'Erro ao ligar'; log('Erro câmera: '+e.message); }
    }
    function stopCamera(){
      if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; }
      cancelAnimationFrame(rafId); ctx.clearRect(0,0,canvas.width,canvas.height);
      camInfo.textContent = 'Câmera parada'; facesCount.textContent = '0 rosto(s)'; fpsEl.textContent='FPS: —';
      log('Câmera parada.');
    }

    async function detectSingle(){
      const res = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold:0.4 }))
        .withFaceLandmarks()
        .withFaceDescriptor();
      return res || null;
    }

    async function enroll(name){
      name = (name||'').trim();
      if(!name){ alert('Informe um nome para cadastro.'); nameInput.focus(); return; }
      const det = await detectSingle();
      if(!det){ log('Cadastro falhou: nenhum rosto detectado.'); alert('Nenhum rosto detectado. Aproxime-se/iluminação.'); return; }
      const desc = Array.from(det.descriptor);
      const db = loadDB();
      let person = db.find(p => p.label===name);
      if(!person){ person = { label:name, descriptors:[] }; db.push(person); }
      person.descriptors.push(desc);
      saveDB(db); buildMatcher();
      log(`Cadastrado "${name}" (amostras: ${person.descriptors.length}).`);
    }

    async function tick(){
      if(!video.srcObject){ rafId = requestAnimationFrame(tick); return; }
      resizeCanvas();
      const ts = performance.now();
      const now = await faceapi
        .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions({ scoreThreshold:0.4 }))
        .withFaceLandmarks()
        .withFaceDescriptors();
      detections = now;
      facesCount.textContent = `${detections.length} rosto(s)`;

      ctx.clearRect(0,0,canvas.width,canvas.height);
      const display = { width: video.videoWidth || canvas.width, height: video.videoHeight || canvas.height };
      const resized = faceapi.resizeResults(detections, display);

      resized.forEach(det => {
        const { x,y,width,height } = det.detection.box;
        ctx.lineWidth = 3; ctx.strokeStyle = '#5aa8ff'; ctx.strokeRect(x,y,width,height);
        let label = '—';
        if (mode==='RECOGNIZE' && matcher){
          const best = matcher.findBestMatch(det.descriptor);
          label = `${best.label} (${best.distance.toFixed(2)})`;
        } else if (mode==='ENROLL'){ label = 'capturar…'; }
        ctx.fillStyle='rgba(14,17,33,.75)';
        const txtW = ctx.measureText(label).width + 14;
        ctx.fillRect(x, y-24, txtW, 22);
        ctx.fillStyle='#e9ecf1'; ctx.font='14px system-ui, -apple-system, Segoe UI, Roboto';
        ctx.fillText(label, x+7, y-8);
      });

      const delta = ts - lastTime; if(delta>0) fpsEl.textContent = 'FPS: ' + Math.round(1000/delta); lastTime = ts;
      rafId = requestAnimationFrame(tick);
    }

    // --------- Bind dos botões ---------
    $('#btnStart').onclick = startCamera;
    $('#btnStop').onclick  = stopCamera;
    $('#btnEnroll').onclick = async ()=>{ mode='ENROLL'; modeEl.textContent=mode; await enroll(nameInput.value); mode='IDLE'; modeEl.textContent=mode; };
    $('#btnRecognize').onclick = ()=>{ mode='RECOGNIZE'; modeEl.textContent=mode; };
    $('#btnIdle').onclick = ()=>{ mode='IDLE'; modeEl.textContent=mode; };

    // Exportar/Importar/Apagar
    $('#btnExport').onclick = ()=>{
      const data = localStorage.getItem('face-db') || '[]';
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href=url; a.download='face-db.json'; a.click(); URL.revokeObjectURL(url);
    };
    $('#btnImport').onclick = ()=> $('#fileImport').click();
    $('#fileImport').addEventListener('change', async (e)=>{
      const f = e.target.files[0]; if(!f) return;
      try{
        const json = JSON.parse(await f.text()); if(!Array.isArray(json)) throw new Error('Formato inválido');
        localStorage.setItem('face-db', JSON.stringify(json)); buildMatcher(); updateDbInfo(); log('Base importada com sucesso.');
      }catch(err){ alert('Falha ao importar: ' + err.message); }
      e.target.value='';
    });
    $('#btnClear').onclick = ()=>{
      if(confirm('Apagar TODA a base local?')){ localStorage.removeItem('face-db'); buildMatcher(); updateDbInfo(); log('Base apagada.'); }
    };

  })();
  </script>
</body>
</html>