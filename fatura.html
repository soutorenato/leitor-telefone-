<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fatura Santander — Despesas x Parcelamentos (só R$)</title>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<style>
:root{--bg:#0f1221;--card:#171a2e;--ink:#eef2ff;--muted:#9aa3b2;--line:#2c3156;--chip:#232842;--accent:#5b8def}
*{box-sizing:border-box}
html,body{margin:0;background:var(--bg);color:var(--ink);font:500 14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{padding:16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{margin:0;font-size:18px}.muted{color:var(--muted)}
main{padding:16px;display:grid;gap:16px;grid-template-columns:1fr}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
.hd{padding:12px 16px;border-bottom:1px dashed var(--line);display:flex;justify-content:space-between;align-items:center}
.hd h2{margin:0;font-size:15px}
.bd{padding:14px 16px}
.btn{appearance:none;border:1px solid var(--line);background:var(--chip);color:var(--ink);padding:8px 12px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:var(--accent)}
.drop{display:flex;align-items:center;justify-content:center;border:2px dashed var(--accent);border-radius:12px;padding:22px;background:linear-gradient(180deg,#101433,#0f1221)}
.drop input{display:none}.drop .inner{text-align:center}
.grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
@media(max-width:1024px){.grid{grid-template-columns:1fr}}
table{width:100%;border-collapse:collapse}
th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
tfoot td{font-weight:700}
.money{font-variant-numeric:tabular-nums}
.small{font-size:12px}
.alert{margin-top:10px;background:#21131b;border:1px solid #5a2030;color:#ffd2da;padding:10px 12px;border-radius:10px}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);background:var(--chip);color:var(--muted);font-size:12px;margin-left:6px}
.kpis{display:flex;gap:10px;flex-wrap:wrap}
.kpi{background:var(--chip);border:1px solid var(--line);border-radius:10px;padding:8px 12px}
.kpi .k{font-size:12px;color:var(--muted)} .kpi .v{font-size:18px;margin-top:2px}
</style>
</head>
<body>
<header>
  <h1>Fatura Santander — Despesas x Parcelamentos</h1>
  <div class="muted">Somando só valores na coluna <b>R$</b>; leitura por coluna para não misturar lados.</div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <h2>Arquivos</h2>
      <button class="btn" id="btnPick">Selecionar PDFs</button>
    </div>
    <div class="bd">
      <label class="drop">
        <input id="fileInput" type="file" accept="application/pdf" multiple/>
        <div class="inner">
          <div style="font-size:15px;margin-bottom:6px">Arraste aqui ou clique em <b>Selecionar PDFs</b></div>
          <div class="muted">Tudo ocorre no seu navegador.</div>
        </div>
      </label>
      <div id="filesInfo" class="small muted" style="margin-top:8px"></div>

      <div class="kpis" style="margin-top:10px">
        <div class="kpi"><div class="k">Itens de Despesa</div><div class="v" id="kDespCount">—</div></div>
        <div class="kpi"><div class="k">Total Despesas (R$)</div><div class="v money" id="kDespTotal">—</div></div>
        <div class="kpi"><div class="k">Itens de Parcelamento</div><div class="v" id="kParcCount">—</div></div>
        <div class="kpi"><div class="k">Total Parcelamentos (R$)</div><div class="v money" id="kParcTotal">—</div></div>
        <div class="kpi"><div class="k">Total Geral (R$)</div><div class="v money" id="kGeral">—</div></div>
      </div>
    </div>
  </section>

  <section class="grid">
    <div class="card">
      <div class="hd"><h2>Despesas <span class="badge" id="badgeDespesas">—</span></h2></div>
      <div class="bd">
        <table id="tblDespesas">
          <thead><tr><th>Data</th><th>Descrição</th><th class="money">R$</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="2">Total Despesas</td><td class="money" id="sumDespesas">—</td></tr></tfoot>
        </table>
        <div id="missDesp" class="alert" style="display:none"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd"><h2>Parcelamentos <span class="badge" id="badgeParcelamentos">—</span></h2></div>
      <div class="bd">
        <table id="tblParcel">
          <thead><tr><th>Data</th><th>Descrição</th><th class="money">R$</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><td colspan="2">Total Parcelamentos</td><td class="money" id="sumParcel">—</td></tr></tfoot>
        </table>
        <div id="missParc" class="alert" style="display:none"></div>
      </div>
    </div>
  </section>
</main>

<script>
/* ===== Utils ===== */
const $$ = s => document.querySelector(s);
const BRL = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const parseBRL = s => Number(String(s).replace(/\s+/g,'').replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''));
const sum = (arr,k) => arr.reduce((a,o)=>a+(k?o[k]:o),0);

/* ===== PDF.js ===== */
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

/* --- Extrai tokens e separa por coluna ANTES de montar linhas --- */
async function extractByColumns(arrayBuffer){
  const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  const all=[];
  for(let p=1;p<=pdf.numPages;p++){
    const page=await pdf.getPage(p);
    const {items}=await page.getTextContent();
    const toks=items.map(it=>{
      const m=it.transform||it.matrix||[1,0,0,1,0,0];
      return {x:m[4], y:m[5], str:(it.str??"").trim()};
    }).filter(t=>t.str);

    if(!toks.length) continue;

    // 2-means simples em X (define "corte" entre colunas)
    let c0=Math.min(...toks.map(t=>t.x)), c1=Math.max(...toks.map(t=>t.x));
    for(let i=0;i<8;i++){
      const L=[], R=[];
      toks.forEach(t=> (Math.abs(t.x-c0)<=Math.abs(t.x-c1)?L:R).push(t));
      const nc0=L.length?L.reduce((s,t)=>s+t.x,0)/L.length:c0;
      const nc1=R.length?R.reduce((s,t)=>s+t.x,0)/R.length:c1;
      if(Math.abs(nc0-c0)<0.5 && Math.abs(nc1-c1)<0.5) break;
      c0=nc0; c1=nc1;
    }
    const cut=(Math.min(c0,c1)+Math.max(c0,c1))/2;
    const left=toks.filter(t=>t.x<=cut), right=toks.filter(t=>t.x>cut);

    const makeLines = arr=>{
      const rows=new Map();
      arr.forEach(t=>{ const y=Math.round(t.y); (rows.get(y)??rows.set(y,[]).get(y)).push(t); });
      const lines=[];
      [...rows.keys()].sort((a,b)=>b-a).forEach(y=>{
        const r=rows.get(y).sort((a,b)=>a.x-b.x);
        const text=r.map(o=>o.str).join(' ').replace(/\s{2,}/g,' ').trim();
        if(text) lines.push({text,y,page:p});
      });
      return lines;
    };

    all.push(...makeLines(left), ...makeLines(right));
  }
  return all; // [{text,y,page}]
}

/* ===== Regras de parsing ===== */
// CAPTURA SÓ O 1º VALOR (R$); 2º (US$) é opcional e ignorado
const RX_DESP = /^\s*(?:\d+\s+)?(?<data>\d{2}\/\d{2})\s+(?<desc>.+?)\s+(?<valor>\d{1,3}(?:\.\d{3})*,\d{2})(?:\s+\d{1,3}(?:\.\d{3})*,\d{2})?\s*$/i;
const RX_PARC = /^\s*(?:\d+\s+)?(?<data>\d{2}\/\d{2})\s+(?<desc>.+?)\s+\d{1,2}\/\d{1,2}\s+(?<valor>\d{1,3}(?:\.\d{3})*,\d{2})(?:\s+\d{1,3}(?:\.\d{3})*,\d{2})?\s*$/i;

// Linha 2/2 contendo apenas o valor em R$
const RX_BRL_ONLY = /(?:^|\s)(\d{1,3}(?:\.\d{3})*,\d{2})(\s|$)/;

// Detecção auxiliar
const RX_ANY_MONEY=/\d{1,3}(?:\.\d{3})*,\d{2}/;
const RX_NEG=/(^|[\s(])-\d/;

// Cabeçalhos
const IS_DESP = l => /^Despesas$/i.test(l) || /^\[Despesas\]/i.test(l);
const IS_PARC = l => /^Parcelamentos$/i.test(l) || /^\[Parcelamentos\]/i.test(l);
const IS_CRED = l => /^Pagamento e Demais Créditos$/i.test(l);
const IS_RESU = l => /^Resumo da Fatura$/i.test(l);

// Linhas a ignorar (somatórios e textos explicativos)
const RX_IGNORE = [
  /^\[(DESPESAS|PARCELAMENTOS)\]\s+VALOR\s+TOTAL\b/i,
  /^VALOR\s+TOTAL\b/i,
  /^\*?\s*Juros\s*=\s*[\d\.,]+\s*\/\s*IOF\s*=\s*[\d\.,]+/i,
  /CET\s*[:\d,\.%]/i,
  /titular pode cancelar esta autorização/i,
  /^\(\+\)|^\(-\)|^Saldo Anterior\b|^Saldo Desta Fatura\b/i
];

// Somar apenas IOF exterior (em R$). NÃO somar “COTAÇÃO DÓLAR …”
const RX_IOF_EXT = /^IOF DESPESA NO EXTERIOR\s+([\d\.,]+)/i;

/* ===== Parser ===== */
function parseFatura(lines, fileName){
  const despesas=[], parcelamentos=[], missDesp=[], missParc=[];
  let ctx="", pending=null; // pending={tipo:'DESP'|'PARC', data, desc}

  for(const {text:raw} of lines){
    const line=raw.replace(/\u00A0/g,' ').trim();
    if(!line) continue;

    // cabeçalhos
    if(IS_DESP(line)){ ctx="DESP"; pending=null; continue; }
    if(IS_PARC(line)){ ctx="PARC"; pending=null; continue; }
    if(IS_CRED(line)){ ctx="CRED"; pending=null; continue; }
    if(IS_RESU(line)){ ctx="RESU"; pending=null; continue; }

    if(ctx==="CRED" || ctx==="RESU") continue;
    if(RX_IGNORE.some(r=>r.test(line))) continue;

    // IOF em R$ (entra como despesa)
    let m=line.match(RX_IOF_EXT);
    if(m){
      const v=parseBRL(m[1]);
      if(isFinite(v)&&v>0) despesas.push({data:"",desc:"IOF DESPESA NO EXTERIOR",valor:v});
      continue;
    }

    // linha completa (R$ capturado é SEMPRE o 1º número monetário)
    let mm=null, tipo=null;
    if((mm=line.match(RX_PARC))){ tipo="PARC"; }
    else if((mm=line.match(RX_DESP))){ tipo="DESP"; }

    if(mm){
      const vStr=mm.groups?.valor||"";
      if(RX_NEG.test(vStr)) continue;
      const valor=parseBRL(vStr); if(!isFinite(valor)||valor<=0) continue;
      const row={data:mm.groups?.data||"",desc:(mm.groups?.desc||"").trim(),valor};
      (tipo==="PARC"?parcelamentos:despesas).push(row);
      pending=null; continue;
    }

    // linha quebrada: data+desc agora, valor na próxima
    const hasDate=/^\s*(?:\d+\s+)?\d{2}\/\d{2}\b/.test(line);
    if(hasDate && !RX_ANY_MONEY.test(line)){
      const data=(line.match(/\d{2}\/\d{2}/)||[""])[0];
      const desc=line.replace(/^\s*(?:\d+\s+)?\d{2}\/\d{2}\b\s*/,'').trim();
      pending={tipo:(ctx==="PARC"?"PARC":"DESP"), data, desc};
      continue;
    }
    if(pending && RX_BRL_ONLY.test(line)){
      const vStr=line.match(RX_BRL_ONLY)[1];
      if(!RX_NEG.test(vStr)){
        const valor=parseBRL(vStr);
        if(isFinite(valor)&&valor>0){
          const row={data:pending.data,desc:pending.desc,valor};
          (pending.tipo==="PARC"?parcelamentos:despesas).push(row);
          pending=null; continue;
        }
      }
    }

    // dentro do bloco com R$ que não casou => log como “suspeita”
    if((ctx==="DESP"||ctx==="PARC") && RX_ANY_MONEY.test(line)){
      (ctx==="PARC"?missParc:missDesp).push({file:fileName,line});
    }
  }
  return {despesas, parcelamentos, missDesp, missParc};
}

/* ===== Render ===== */
function renderRows(tbody, rows){
  tbody.innerHTML="";
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono">${r.data}</td><td>${r.desc}</td><td class="money">${BRL(r.valor)}</td>`;
    tbody.appendChild(tr);
  });
}
function updateSums(desp, parc){
  const sDesp=sum(desp,'valor'), sParc=sum(parc,'valor');
  $$("#sumDespesas").textContent=BRL(sDesp);
  $$("#sumParcel").textContent=BRL(sParc);
  $$("#kDespTotal").textContent=BRL(sDesp);
  $$("#kParcTotal").textContent=BRL(sParc);
  $$("#kGeral").textContent=BRL(sDesp+sParc);
  $$("#kDespCount").textContent=desp.length;
  $$("#kParcCount").textContent=parc.length;
  $$("#badgeDespesas").textContent=`${desp.length} itens`;
  $$("#badgeParcelamentos").textContent=`${parc.length} itens`;
}
function renderMiss(box, misses){
  if(!misses.length){ box.style.display="none"; box.innerHTML=""; return; }
  box.style.display="block";
  const byFile=misses.reduce((m,o)=>{(m[o.file]=m[o.file]||[]).push(o);return m;}, {});
  let html="<b>Linhas com R$ não capturadas</b><br/>Se alguma é lançamento válido, me diga a linha para eu ajustar o padrão:";
  for(const f in byFile){
    html+=`<div style="margin-top:6px"><b>${f}</b><ul class="small">`;
    byFile[f].slice(0,20).forEach(x=> html+=`<li><span class="mono">${x.line}</span></li>`);
    if(byFile[f].length>20) html+=`<li>… (+${byFile[f].length-20})</li>`;
    html+="</ul></div>";
  }
  box.innerHTML=html;
}

/* ===== Fluxo ===== */
const input=$$("#fileInput"); $$("#btnPick").addEventListener('click',()=>input.click());
input.addEventListener('change', e=>handleFiles([...e.target.files]));
document.querySelector('.drop').addEventListener('drop',e=>{e.preventDefault();handleFiles([...e.dataTransfer.files].filter(f=>/pdf$/i.test(f.name)));});
['dragover','dragenter'].forEach(ev=>document.querySelector('.drop').addEventListener(ev,e=>e.preventDefault()));

async function handleFiles(files){
  if(!files?.length) return;
  $$("#filesInfo").textContent=`Lendo ${files.length} arquivo(s)…`;
  let allDesp=[], allParc=[], missD=[], missP=[];
  for(const f of files){
    try{
      const buf=await f.arrayBuffer();
      const colLines=await extractByColumns(buf);
      const {despesas,parcelamentos,missDesp,missParc}=parseFatura(colLines, f.name);
      allDesp=allDesp.concat(despesas);
      allParc=allParc.concat(parcelamentos);
      missD=missD.concat(missDesp); missP=missP.concat(missParc);
    }catch(err){ console.error(err); alert(`Erro lendo "${f.name}": ${err.message||err}`); }
  }
  // ordena por data (dd/mm) e descrição
  const ord=(a,b)=> (a.data||"").localeCompare(b.data||"") || a.desc.localeCompare(b.desc);
  allDesp.sort(ord); allParc.sort(ord);

  renderRows($$("#tblDespesas tbody"), allDesp);
  renderRows($$("#tblParcel tbody"), allParc);
  updateSums(allDesp, allParc);
  renderMiss($$("#missDesp"), missD);
  renderMiss($$("#missParc"), missP);
  $$("#filesInfo").textContent=`Processadas ${files.length} fatura(s). Despesas: ${allDesp.length} • Parcelamentos: ${allParc.length}`;
}
</script>
</body>
</html>