<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Fatura Santander ‚Äì Parser robusto (2 colunas, s√≥ R$)</title>
<script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.min.js"></script>
<style>
:root{--bg:#0f1221;--card:#171a2e;--muted:#9aa3b2;--text:#eef2ff;--accent:#5b8def;--ok:#35c48b;--warn:#ffb020;--chip:#232842;--line:#2c3156}
*{box-sizing:border-box} html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:500 14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
header{padding:16px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0}.muted{color:var(--muted)}
main{padding:16px;display:grid;gap:16px;grid-template-columns:1.05fr 2fr}
@media(max-width:1100px){main{grid-template-columns:1fr}}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
.hd{padding:12px 16px;border-bottom:1px dashed var(--line);display:flex;justify-content:space-between;align-items:center}
.hd h2{margin:0;font-size:15px}
.bd{padding:14px 16px}
.drop{display:flex;align-items:center;justify-content:center;border:2px dashed var(--accent);border-radius:12px;padding:22px;background:linear-gradient(180deg,#101433,#0f1221)}
.drop input{display:none}.drop .inner{text-align:center}
.btn{appearance:none;border:1px solid var(--line);background:#232842;color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
.btn:hover{border-color:var(--accent)} .btn.secondary{background:transparent}
.btnbar{display:flex;gap:8px;flex-wrap:wrap}
.srch{border:1px solid var(--line);background:#232842;color:var(--text);border-radius:8px;padding:8px 10px}
.flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.right{margin-left:auto}
.statgrid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
@media(max-width:950px){.statgrid{grid-template-columns:1fr 1fr}}
.stat{background:#232842;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
.stat .k{font-size:12px;color:var(--muted)} .stat .v{font-size:18px;margin-top:4px}
.money{font-variant-numeric:tabular-nums}
.tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px}
.tag{background:#232842;border:1px solid var(--line);padding:4px 8px;border-radius:999px;color:var(--muted);font-size:12px}
.pill{font-size:12px;color:#c9d2ff;background:rgba(91,141,239,.15);border:1px solid rgba(91,141,239,.35);padding:2px 8px;border-radius:999px}
.alert{background:#21131b;border:1px solid #5a2030;color:#ffd2da;padding:10px 12px;border-radius:10px}
table{width:100%;border-collapse:collapse} th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;vertical-align:top}
th{font-size:12px;color:var(--muted);text-transform:uppercase;letter-spacing:.04em}
h3{margin:16px 0 8px}
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:1100px){.grid-2{grid-template-columns:1fr}}
canvas{width:100%;height:240px;display:block;background:#12162b;border:1px solid var(--line);border-radius:10px}
.badge-ok{color:#0f1;display:inline-block;margin-left:6px}
.badge-warn{color:#ffb020;display:inline-block;margin-left:6px}
.mono{font-family:ui-monospace,SFMono,Consolas,monospace}
.small{font-size:12px}
</style>
</head>
<body>
<header>
  <h1>üîé Fatura Santander ‚Äì Parser robusto</h1>
  <div class="muted">2 colunas ‚Ä¢ s√≥ R$ ‚Ä¢ ignora textos explicativos ‚Ä¢ reconcilia√ß√£o com Resumo.</div>
</header>

<main>
  <!-- Coluna 1: Upload & KPIs -->
  <section class="card">
    <div class="hd">
      <h2>Upload de Faturas</h2>
      <div class="btnbar">
        <button class="btn" id="btnPick">Selecionar PDFs</button>
        <button class="btn secondary" id="btnClear">Limpar</button>
        <button class="btn secondary" id="btnExport">Exportar CSV</button>
      </div>
    </div>
    <div class="bd">
      <label class="drop" id="dropzone">
        <input id="fileInput" type="file" accept="application/pdf" multiple/>
        <div class="inner">
          <div style="font-size:15px;margin-bottom:6px">Arraste PDFs aqui ou clique em <b>Selecionar PDFs</b></div>
          <div class="muted">Processamento local: nada sai do navegador.</div>
        </div>
      </label>
      <div id="filesInfo" class="muted" style="margin-top:8px"></div>

      <div class="statgrid" style="margin-top:10px">
        <div class="stat"><div class="k">Total analisado (R$)</div><div class="v money" id="kTotal">‚Äî</div></div>
        <div class="stat"><div class="k">Transa√ß√µes</div><div class="v" id="kCount">‚Äî</div></div>
        <div class="stat"><div class="k">Maior categoria</div><div class="v" id="kTopCat">‚Äî</div></div>
        <div class="stat"><div class="k">Assinaturas detectadas</div><div class="v" id="kSubs">‚Äî</div></div>
      </div>

      <h3>Reconcilia√ß√£o por arquivo</h3>
      <table id="tblRecon">
        <thead>
          <tr>
            <th>Arquivo</th>
            <th>Despesas capturadas (R$)</th>
            <th>Despesas do Resumo (R$)</th>
            <th>Diferen√ßa</th>
            <th>Saldo desta fatura (Resumo)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div class="tags" id="chipsRecon"></div>
      <div id="missList" class="small" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Coluna 2: Gr√°ficos & Tabelas -->
  <section class="card">
    <div class="hd">
      <h2>Vis√£o Anal√≠tica</h2>
      <div class="flex right">
        <select id="categoryFilter" class="srch"><option value="">Todas as categorias</option></select>
        <input id="searchBox" class="srch" type="search" placeholder="Buscar estabelecimento..."/>
      </div>
    </div>
    <div class="bd">
      <div class="grid-2">
        <div>
          <h3>Participa√ß√£o por categoria (Rosca)</h3>
          <canvas id="chDonut"></canvas>
        </div>
        <div>
          <h3>Pareto 80/20 (Categorias)</h3>
          <canvas id="chPareto"></canvas>
        </div>
      </div>

      <h3 style="margin-top:16px">Ranking por categoria</h3>
      <table id="tblCats">
        <thead><tr><th>Categoria</th><th>Total</th><th>%</th><th>Qtd</th></tr></thead>
        <tbody></tbody>
      </table>

      <h3 style="margin-top:16px">Transa√ß√µes</h3>
      <table id="tblTx">
        <thead><tr><th>Arquivo</th><th>Data</th><th>Estabelecimento</th><th>Categoria</th><th class="money">Valor (R$)</th><th>Origem</th></tr></thead>
        <tbody></tbody>
      </table>

      <h3 style="margin-top:16px">Plano de economia sugerido</h3>
      <div id="adviceBox" class="alert">Carregue as faturas para ver oportunidades com n√∫meros.</div>
    </div>
  </section>
</main>

<script>
/* ===== Utils ===== */
const $$ = s => document.querySelector(s);
const BRL = n => n.toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
const parseBRL = s => Number(String(s).replace(/\s+/g,'').replace(/\./g,'').replace(',','.').replace(/[^\d.-]/g,''));
const sum = (arr,k) => arr.reduce((acc,o)=>acc+(k?o[k]:o),0);

/* ===== Categorias ===== */
const categoryRules = [
  { cat:"Combust√≠vel", rx: /(ABASTEC\*ABASTECE AI|AUTO\s*POSTO|POSTO\s|ABASTEC)/i },
  { cat:"Ped√°gio/Tag & Vias", rx: /(CONCESSIONARIA|RENOVIAS|RODOANEL|ECOPISTA|AUTOBAN|SEM PARAR|BANDEIRANTES)/i },
  { cat:"Transporte (Apps)", rx: /\bUBER\b|\b99\b/i },
  { cat:"Estacionamento", rx: /(ESTAPAR|ESTACIONAMENTO|PARK)/i },
  { cat:"Supermercado", rx: /(SUPERMERCADO|ATACADISTA|ATACAREJO|REDE ROFATTO|CINCO M COM ATACADISTA|DU BAIRRO)/i },
  { cat:"Padaria/Lanches", rx: /(PADARIA|PANIFICADORA|LANCHONETE|PAES E DOCES|PASTEL|ACA[I√ç]|PUMILA|CABANA DO ACAI|LAUFRUTAS)/i },
  { cat:"Restaurantes", rx: /(RESTAURANTE|GRILL|PIZZARIA|ESFIHARIA|BURGER|RASCAL|TENNESSEE|ZIG\*CANA|SABOR)/i },
  { cat:"Sa√∫de/Farm√°cia", rx: /(DROGASIL|DROGARIA|RAIA|FARMACIA|REMEDIOPOPULAR)/i },
  { cat:"Pets", rx: /(PETZ|PET SHOP)/i },
  { cat:"Assinaturas/Apps", rx: /(APPLE COM\/BILL|AMAZON (?:MUSIC|DIGITAL|PRIME)|DL\*GOOGLE|GOOGLE ONE|NETFLIX|SPOTIFY|GLOBO|MICROSOFT|ADOBE)/i },
  { cat:"Educa√ß√£o/Livros", rx: /(LIVRARIA|CURSO|ESCOLA|HEDRA)/i },
  { cat:"Compras Online", rx: /(AMAZONMKTPLC|MERCADOPAGO|MAGAZINE|SUBMARINO|SHOPEE)/i },
  { cat:"Beleza/Est√©tica", rx: /(SAL[A√É]O|BELEZA|SPA|CAPELLI|CONCETTO)/i },
  { cat:"Auto/Servi√ßos", rx: /(LAVA R[A√Å]PIDO|AUTOMOTIVO|OFICINA|AUTO POSTO)/i },
  { cat:"Viagem/Hospedagem", rx: /(AIRBNB|LOCALIZA|UNIDAS|BOOKING|HOTEL)/i },
  { cat:"Servi√ßos Online", rx: /(HOSTGATOR|DOM[I√ç]NIO|HOSPEDAGEM)/i },
  { cat:"Juros/Parcelamento", rx: /(PARC SALDO DE FATURA|PARCELA\s+\d+\/\d+|CREDI[√ÅA]RIO|JUROS|ENCARGOS)/i },
  { cat:"Tarifas/Anuidade", rx: /(ANUIDADE|TARIFA)/i },
  { cat:"Impostos/Exterior", rx: /(COTA[√áC][A√É]O D[√ìO]LAR|IOF DESPESA NO EXTERIOR)/i },
  { cat:"Bancos/Servi√ßos", rx: /(SCP PLUS|SEGURO CART[A√É]O)/i },
  { cat:"Outros", rx: /.*/i }
];
const subscriptionRules = /(APPLE COM\/BILL|AMAZON (?:MUSIC|PRIME|DIGITAL)|DL\*GOOGLE|GOOGLE ONE|NETFLIX|SPOTIFY|GLOBO|MICROSOFT|ADOBE|PREMIERE)/i;

/* ===== pdf.js ===== */
pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdn.jsdelivr.net/npm/pdfjs-dist@2.16.105/build/pdf.worker.min.js';

/* === Extra√ß√£o com consci√™ncia de colunas === */
async function extractColAwareLines(arrayBuffer){
  const pdf=await pdfjsLib.getDocument({data:arrayBuffer}).promise;
  const all=[]; // {text, xAvg, y, page}
  for(let p=1;p<=pdf.numPages;p++){
    const page=await pdf.getPage(p);
    const content=await page.getTextContent();
    const rows=new Map(); // y-> [ {x,str} ]
    for(const it of content.items){
      const str=it.str??"";
      const tr=it.transform||it.matrix||[1,0,0,1,0,0];
      const x=tr[4], y=tr[5];
      const yKey=Math.round(y);
      (rows.get(yKey)??rows.set(yKey,[]).get(yKey)).push({x,str});
    }
    // monta linhas preservando x e guarda xAvg pra clusterizar em colunas
    const yKeys=[...rows.keys()].sort((a,b)=>b-a);
    const lines=[];
    for(const y of yKeys){
      const arr=rows.get(y).sort((a,b)=>a.x-b.x);
      const text=arr.map(o=>o.str).join(' ').replace(/\s{2,}/g,' ').trim();
      if(!text) continue;
      const xAvg = arr.reduce((s,o)=>s+o.x,0)/arr.length;
      lines.push({text, xAvg, y, page:p});
    }
    // 2-means super simples por xAvg pra separar esquerda/direita
    if(lines.length){
      const xs=lines.map(l=>l.xAvg).sort((a,b)=>a-b);
      const mid=(xs[Math.floor(xs.length/2)] + xs[Math.ceil(xs.length/2)-1])/2;
      const left = lines.filter(l=>l.xAvg<=mid);
      const right= lines.filter(l=>l.xAvg> mid);
      // ordena verticalmente em cada coluna (de cima pra baixo como j√° est√° por y desc)
      // e concatena coluna esquerda inteira seguida da direita (emula leitura de jornal)
      left.sort((a,b)=>b.y-a.y); right.sort((a,b)=>b.y-a.y);
      all.push(...left, ...right);
    }
  }
  return all; // [{text,xAvg,y,page}]
}

/* ===== Parsers ===== */
/* Somente a 1¬™ coluna de valor em R$ (ignora US$/2¬∫ valor) */
const rxDespesaLine = /^\s*(?:\d+\s+)?(?<data>\d{2}\/\d{2})\b\s+(?<desc>.+?)\s+(?<valor>\d{1,3}(?:\.\d{3})*,\d{2})/i;
/* Parcelamento: tem "n/n" antes do valor */
const rxParcLine    = /^\s*(?:\d+\s+)?(?<data>\d{2}\/\d{2})\b\s+(?<desc>.+?)\s+\d{1,2}\/\d{1,2}\s+(?<valor>\d{1,3}(?:\.\d{3})*,\d{2})/i;
/* Linha que tem s√≥ um valor (pode ser continua√ß√£o da anterior) */
const rxBRLOnly     = /(?:^|\s)(\d{1,3}(?:\.\d{3})*,\d{2})(\s|$)/;
/* Qualquer valor R$ (para ca√ßar ‚Äúsuspeitas‚Äù) */
const rxMoneyAny    = /\d{1,3}(?:\.\d{3})*,\d{2}/;
/* Negativos (cr√©ditos/estornos) */
const rxNeg         = /(^|[\s(])-\d/;

/* Ignorar anota√ß√µes/avisos explicativos */
const rxIgnoreLines = [
  /^\*?\s*Juros\s*=\s*[\d\.,]+\s*\/\s*IOF\s*=\s*[\d\.,]+/i,
  /^\[?(DESPESAS|PARCELAMENTOS)\]?/i,
  /CET\s*[:\d,\.%]/i,
  /titular pode cancelar esta autoriza√ß√£o/i,
  /^\(\+\)|^\(-\)|^Saldo Anterior\b|^Saldo Desta Fatura\b/i
];

/* Cabe√ßalhos de blocos */
const isDespesas     = l => /^Despesas$/i.test(l);
const isParcelamentos= l => /^Parcelamentos$/i.test(l);
const isCreditos     = l => /^Pagamento e Demais Cr√©ditos$/i.test(l);
const isResumo       = l => /^Resumo da Fatura$/i.test(l);

/* Itens de exterior em R$ (s√£o despesas v√°lidas) */
const rxCotacaoDolar = /^COTA[√áC][A√É]O D[√ìO]LAR R\$\s*([\d\.,]+)/i;
const rxIOFExterior  = /^IOF DESPESA NO EXTERIOR\s+([\d\.,]+)/i;

function categorize(desc){
  const r=categoryRules.find(r=>r.rx.test(desc));
  return r? r.cat : "Outros";
}

/* Parser tolerante de contexto + 2 linhas */
function parseTransacoes(colLines, fileName){
  const tx=[]; const misses=[];
  let ctx=""; // DESPESAS, PARCELAMENTOS, CREDITOS, RESUMO, ""
  let pending=null; // {data, desc} aguardando valor na pr√≥xima linha

  for(const {text:lineRaw} of colLines){
    const line=lineRaw.replace(/\u00A0/g,' ').trim();

    // cabe√ßalhos
    if(isDespesas(line)){ ctx="DESPESAS"; pending=null; continue; }
    if(isParcelamentos(line)){ ctx="PARCELAMENTOS"; pending=null; continue; }
    if(isCreditos(line)){ ctx="CREDITOS"; pending=null; continue; }
    if(isResumo(line)){ ctx="RESUMO"; pending=null; continue; }

    // ignorar blocos n√£o contabiliz√°veis
    if(ctx==="CREDITOS" || ctx==="RESUMO") continue;

    // ignorar textos explicativos
    if(rxIgnoreLines.some(re=>re.test(line))) continue;

    // capturar itens de exterior (em R$)
    let m=line.match(rxCotacaoDolar);
    if(m){
      const v=parseBRL(m[1]); if(isFinite(v)&&v>0)
        tx.push({file:fileName,data:"",desc:"COTA√á√ÉO D√ìLAR",valor:v,cat:"Impostos/Exterior",origem:"Despesas",sub:false});
      continue;
    }
    m=line.match(rxIOFExterior);
    if(m){
      const v=parseBRL(m[1]); if(isFinite(v)&&v>0)
        tx.push({file:fileName,data:"",desc:"IOF DESPESA NO EXTERIOR",valor:v,cat:"Impostos/Exterior",origem:"Despesas",sub:false});
      continue;
    }

    // 1) Tenta casar linha completa (parcelamento ou despesa)
    let mm=null, origem=null;
    mm = line.match(rxParcLine);
    if(mm){ origem="Parcelamentos"; }
    else { mm = line.match(rxDespesaLine); origem="Despesas"; }

    if(mm){
      const valorStr=mm.groups?.valor||"";
      if(rxNeg.test(valorStr)) continue; // estorno/cr√©dito
      const valor=parseBRL(valorStr); if(!isFinite(valor)||valor<=0) continue;
      const data=mm.groups?.data||""; const desc=(mm.groups?.desc||"").trim();
      tx.push({file:fileName,data,desc,valor,cat:categorize(desc),origem,sub:subscriptionRules.test(desc)});
      pending=null;
      continue;
    }

    // 2) Caso quebrou em 2 linhas (linha 1 com data+desc, linha 2 com valor)
    // se a linha atual come√ßa com data e n√£o tem valor => guarda pendente
    const startWithDate = /^\s*(?:\d+\s+)?\d{2}\/\d{2}\b/.test(line);
    if(startWithDate && !rxMoneyAny.test(line)){
      // guarda apenas data+descri√ß√£o; valor ser√° na pr√≥xima
      const data = (line.match(/\d{2}\/\d{2}/)||[""])[0];
      const desc = line.replace(/^\s*(?:\d+\s+)?\d{2}\/\d{2}\b\s*/,'').trim();
      pending = {data,desc,origem: (ctx==="PARCELAMENTOS"?"Parcelamentos":"Despesas")};
      continue;
    }
    // se h√° pendente e a linha atual cont√©m um valor R$, usa-o
    if(pending && rxBRLOnly.test(line)){
      const vStr=line.match(rxBRLOnly)[1]; 
      if(!rxNeg.test(vStr)){
        const valor=parseBRL(vStr);
        if(isFinite(valor)&&valor>0){
          tx.push({file:fileName,data:pending.data,desc:pending.desc,valor,cat:categorize(pending.desc),origem:pending.origem,sub:subscriptionRules.test(pending.desc)});
          pending=null; 
          continue;
        }
      }
    }

    // 3) Modo tolerante: mesmo sem ‚ÄúDespesas/Parcelamentos‚Äù, se uma linha isolada parece um lan√ßamento (data + valor)
    if(!ctx && ( rxParcLine.test(line) || rxDespesaLine.test(line) )){
      const mm2 = line.match(rxParcLine) || line.match(rxDespesaLine);
      const valorStr=mm2.groups?.valor||""; if(rxNeg.test(valorStr)) continue;
      const valor=parseBRL(valorStr); if(!isFinite(valor)||valor<=0) continue;
      const data=mm2.groups?.data||""; const desc=(mm2.groups?.desc||"").trim();
      tx.push({file:fileName,data,desc,valor,cat:categorize(desc),origem: rxParcLine.test(line)?"Parcelamentos":"Despesas",sub:subscriptionRules.test(desc)});
      continue;
    }

    // 4) Se estamos em DESPESAS/PARCELAMENTOS e a linha tem R$ mas n√£o casou => registrar como ‚Äúsuspeita‚Äù
    if((ctx==="DESPESAS"||ctx==="PARCELAMENTOS") && rxMoneyAny.test(line)){
      misses.push({file:fileName, ctx, line});
    }
  }
  return {tx, misses};
}

/* Parser do Resumo da Fatura */
function parseResumo(colLines, fileName){
  const out={file:fileName,saldoAnterior:0,jurosRemu:0,iof:0,jurosMora:0,multa:0,despesasBR:0,despesasEX:0,pagamentos:0,creditos:0,saldoFatura:0};
  let inside=false;
  for(const {text:raw} of colLines){
    const line=raw.replace(/\u00A0/g,' ').trim();
    if(/^Resumo da Fatura$/i.test(line)){ inside=true; continue; }
    if(!inside) continue;
    if(/^Detalhamento|^Central|^Ouvidoria|^SAC|^Compra/i.test(line)) break;
    const g=(re)=>{const m=line.match(re); return m?parseBRL(m[1]):null;};
    let v;
    if((v=g(/Saldo Anterior\s+([\d\.,]+)/i))!=null) out.saldoAnterior=v;
    if((v=g(/Juros Remunerat[√≥o]rios\s+([\d\.,]+)/i))!=null) out.jurosRemu=v;
    if((v=g(/IOF\s+([\d\.,]+)/i))!=null) out.iof=v;
    if((v=g(/Juros de Mora\s+([\d\.,]+)/i))!=null) out.jurosMora=v;
    if((v=g(/Multa por Atraso\s+([\d\.,]+)/i))!=null) out.multa=v;
    if((v=g(/Total Despesas\/D[e√©]bitos no Brasil\s+([\d\.,]+)/i))!=null) out.despesasBR=v;
    if((v=g(/Total Despesas\/D[e√©]bitos no Exterior\s+([\d\.,]+)/i))!=null) out.despesasEX=v;
    if((v=g(/Total de pagamentos\s+([\d\.,]+)/i))!=null) out.pagamentos=v;
    if((v=g(/Total de cr[e√©]ditos\s+([\d\.,]+)/i))!=null) out.creditos=v;
    if((v=g(/Saldo Desta Fatura\s+([\d\.,]+)/i))!=null) out.saldoFatura=v;
  }
  return out;
}

/* ===== Estado ===== */
let ALL_TX=[];   // {file,data,desc,valor,cat,origem,sub}
let RECON=[];    // resumo por arquivo
let MISSES=[];   // linhas suspeitas n√£o capturadas

/* ===== UI & Fluxo ===== */
const input=$$("#fileInput"), drop=$$("#dropzone");
$$("#btnPick").addEventListener('click',()=>input.click());
["dragenter","dragover"].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='#35c48b'}));
["dragleave","drop"].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.style.borderColor='var(--accent)'}));
drop.addEventListener('drop',e=>handleFiles([...e.dataTransfer.files].filter(f=>/pdf$/i.test(f.name))));
input.addEventListener('change',e=>handleFiles([...e.target.files]));

$$("#btnClear").addEventListener('click',()=>{
  input.value=""; ALL_TX=[]; RECON=[]; MISSES=[];
  $$("#filesInfo").textContent=""; renderRecon(); refreshFilters(); renderAll();
});
$$("#btnExport").addEventListener('click',()=>{
  if(!ALL_TX.length) return alert("Nada para exportar.");
  const esc=v=>`"${String(v).replace(/"/g,'""')}"`;
  const header=["arquivo","data","descricao","categoria","valor","origem","assinatura"];
  const rows=[header.join(";")];
  ALL_TX.forEach(r=>rows.push([r.file,r.data,r.desc,r.cat,r.valor.toFixed(2),r.origem,r.sub?"sim":"n√£o"].map(esc).join(";")));
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([rows.join("\n")],{type:'text/csv;charset=utf-8'}));
  a.download=`transacoes-${new Date().toISOString().slice(0,10)}.csv`; a.click();
});

async function handleFiles(files){
  if(!files?.length) return;
  $$("#filesInfo").textContent=`Lendo ${files.length} fatura(s)...`;
  let all=[], recon=[], missesTotal=[];
  for(const f of files){
    try{
      const buf=await f.arrayBuffer();
      const colLines=await extractColAwareLines(buf);    // ‚≠êÔ∏è consciente de colunas
      const {tx,misses}=parseTransacoes(colLines, f.name);
      const r=parseResumo(colLines, f.name);
      all=all.concat(tx); recon.push(r); missesTotal=missesTotal.concat(misses);
    }catch(err){ console.error(err); alert(`Falha ao ler "${f.name}": ${err.message||err}`); }
  }
  ALL_TX=all; RECON=recon; MISSES=missesTotal;
  $$("#filesInfo").textContent=`Processadas ${files.length} fatura(s). Lan√ßamentos capturados: ${ALL_TX.length}.`;
  renderRecon(); refreshFilters(); renderAll();
}

/* ===== Reconcilia√ß√£o ===== */
function renderRecon(){
  const tb=$$("#tblRecon tbody"); tb.innerHTML="";
  const chips=$$("#chipsRecon"); chips.innerHTML="";
  const missBox=$$("#missList"); missBox.innerHTML="";

  // soma por arquivo
  const sumByFile = {};
  ALL_TX.forEach(t => { sumByFile[t.file]=(sumByFile[t.file]||0)+t.valor; });

  // KPIs globais
  const totalAnalise = sum(ALL_TX,'valor');
  $$("#kTotal").textContent = BRL(totalAnalise);
  $$("#kCount").textContent = ALL_TX.length;
  const topCat = byCategory(ALL_TX)[0];
  $$("#kTopCat").textContent = topCat ? `${topCat.cat} (${BRL(topCat.total)})` : "‚Äî";
  $$("#kSubs").textContent = ALL_TX.filter(t=>t.sub).length;

  // tabela por arquivo
  RECON.forEach(r=>{
    const cap = sumByFile[r.file] || 0;
    const resumoDespesas = (r.despesasBR||0) + (r.despesasEX||0);
    const diff = +(cap - resumoDespesas).toFixed(2);
    const ok = Math.abs(diff) < 0.05;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td>${r.file} ${ok?'<span class="badge-ok">‚úîÔ∏è</span>':'<span class="badge-warn">‚ö†Ô∏è</span>'}</td>
      <td class="money">${BRL(cap)}</td>
      <td class="money">${BRL(resumoDespesas)}</td>
      <td class="money" style="color:${ok?'#35c48b':'#ffb020'}">${BRL(diff)}</td>
      <td class="money">${BRL(r.saldoFatura||0)}</td>
    `;
    tb.appendChild(tr);

    const chip=document.createElement('span');
    chip.className='tag';
    chip.textContent=`${r.file}: capturadas ${BRL(cap)} ‚Ä¢ resumo ${BRL(resumoDespesas)} ‚Ä¢ diff ${BRL(diff)}`;
    chips.appendChild(chip);
  });

  // linhas suspeitas (para identificar formatos que ainda escapem)
  if(MISSES.length){
    const byFile = MISSES.reduce((m,o)=>{ (m[o.file]=m[o.file]||[]).push(o); return m; }, {});
    let html = `<div class="alert"><b>Linhas suspeitas n√£o lidas</b> (t√™m R$ em DESPESAS/PARCELAMENTOS, mas n√£o casaram ‚Äî ajusto o padr√£o com base nisso):</div>`;
    for(const file in byFile){
      html += `<div style="margin-top:8px"><b>${file}</b><ul class="small">`;
      byFile[file].slice(0,25).forEach(m => { html += `<li>[${m.ctx}] <span class="mono">${m.line}</span></li>`; });
      if(byFile[file].length>25) html += `<li>‚Ä¶ (+${byFile[file].length-25})</li>`;
      html += `</ul></div>`;
    }
    missBox.innerHTML = html;
  }
}

/* ===== Agrega√ß√µes & Render ===== */
function byCategory(arr){
  const m=new Map();
  arr.forEach(t=>{
    const a=m.get(t.cat)||{cat:t.cat,total:0,count:0};
    a.total+=t.valor; a.count++; m.set(t.cat,a);
  });
  return [...m.values()].sort((a,b)=>b.total-a.total);
}
function refreshFilters(){
  const cats=[...new Set(ALL_TX.map(t=>t.cat))].sort();
  const sel=$$("#categoryFilter"); const cur=sel.value;
  sel.innerHTML = `<option value="">Todas as categorias</option>` + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
  if(cats.includes(cur)) sel.value=cur;
}
$$("#categoryFilter").addEventListener('change',()=>renderAll());
$$("#searchBox").addEventListener('input',()=>renderAll());

function renderAll(){
  const cat=$$("#categoryFilter").value, q=$$("#searchBox").value.trim().toLowerCase();
  const view=ALL_TX.filter(t=>(!cat||t.cat===cat)&&(!q||t.desc.toLowerCase().includes(q)));

  // categorias
  const tbC=$$("#tblCats tbody"); tbC.innerHTML="";
  const total=sum(view,'valor');
  byCategory(view).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td><span class="pill">${r.cat}</span></td>
      <td class="money">${BRL(r.total)}</td>
      <td>${(100*r.total/(total||1)).toFixed(1)}%</td>
      <td>${r.count}</td>`;
    tbC.appendChild(tr);
  });

  // transa√ß√µes
  const tbT=$$("#tblTx tbody"); tbT.innerHTML="";
  view.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td class="mono small">${t.file}</td>
      <td class="mono">${t.data}</td>
      <td>${t.desc}</td>
      <td><span class="pill">${t.cat}</span></td>
      <td class="money">${BRL(t.valor)}</td>
      <td class="muted">${t.origem}</td>`;
    tbT.appendChild(tr);
  });

  // gr√°ficos
  const cats=byCategory(view).map(r=>({k:r.cat,v:r.total}));
  drawDonut($$("#chDonut").getContext('2d'), cats);
  drawPareto($$("#chPareto").getContext('2d'), cats);

  // plano (resumo)
  const top=byCategory(view);
  const cut1=(top[0]?.total||0)*0.15, cut2=(top[1]?.total||0)*0.10, cutRest=top.slice(2,5).reduce((s,c)=>s+c.total*0.07,0);
  const monthly = cut1+cut2+cutRest;
  $$("#adviceBox").innerHTML = `Potencial mensal: <b style="color:#35c48b">${BRL(monthly)}</b> (15% em <b>${top[0]?.cat||"‚Äî"}</b>, 10% em <b>${top[1]?.cat||"‚Äî"}</b>, 7% em ${top.slice(2,5).map(c=>`<b>${c.cat}</b>`).join(', ')||'‚Äî'}).`;
}

/* ===== Gr√°ficos (Canvas) ===== */
function clearCanvas(ctx){const {width:w,height:h}=ctx.canvas; ctx.clearRect(0,0,w,h);}
function drawDonut(ctx, data){
  clearCanvas(ctx);
  const w=ctx.canvas.width=ctx.canvas.clientWidth*2, h=ctx.canvas.height=ctx.canvas.clientHeight*2;
  const r=Math.min(w,h)*0.32, cx=w/2, cy=h/2, hole=r*0.60;
  const tot=data.reduce((s,d)=>s+d.v,0)||1; let a0=-Math.PI/2;
  data.forEach((d,i)=>{
    const a=a0+2*Math.PI*(d.v/tot);
    ctx.beginPath(); ctx.moveTo(cx,cy);
    ctx.fillStyle=`hsl(${(i*63)%360} 70% 55%)`;
    ctx.arc(cx,cy,r,a0,a); ctx.arc(cx,cy,hole,a,a0,true); ctx.fill();
    a0=a;
  });
  ctx.fillStyle="#cfd6ff"; ctx.textAlign="center"; ctx.textBaseline="middle";
  ctx.font="700 26px ui-sans-serif"; ctx.fillText((tot).toLocaleString('pt-BR',{style:'currency',currency:'BRL'}), cx, cy-10);
  ctx.font="500 14px ui-sans-serif"; ctx.fillText("Total", cx, cy+12);
}
function drawPareto(ctx,data){
  clearCanvas(ctx);
  const w=ctx.canvas.width=ctx.canvas.clientWidth*2, h=ctx.canvas.clientHeight*2;
  const pad=50, plotW=w-2*pad, plotH=h-2*pad, x0=pad, y0=h-pad;
  const tot=data.reduce((s,d)=>s+d.v,0)||1; const max=Math.max(...data.map(d=>d.v),1);
  // eixos
  ctx.strokeStyle="#2c3156"; ctx.lineWidth=2;
  ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y0-plotH); ctx.lineTo(x0+plotW,y0-plotH); ctx.stroke();
  // barras + curva
  let acc=0;
  data.forEach((d,i)=>{
    const step=plotW/data.length, x=x0+i*step+6, bw=step-12;
    const hBar=(d.v/max)*plotH;
    ctx.fillStyle=`hsl(${(i*63)%360} 70% 55%)`; ctx.fillRect(x,y0-hBar,bw,hBar);
    acc+=d.v; const xC=x0+(i+0.5)*step, yC=y0-(acc/tot)*plotH;
    ctx.fillStyle="#fff"; ctx.beginPath(); ctx.arc(xC,yC,4,0,6.283); ctx.fill();
    if(i){const xP=x0+(i-0.5)*step, yP=y0-((acc-d.v)/tot)*plotH; ctx.strokeStyle="#cfd6ff"; ctx.beginPath(); ctx.moveTo(xP,yP); ctx.lineTo(xC,yC); ctx.stroke();}
  });
  // linha de 80%
  ctx.setLineDash([6,6]); ctx.strokeStyle="#ffb020aa";
  const y80=y0-0.8*plotH; ctx.beginPath(); ctx.moveTo(x0,y80); ctx.lineTo(x0+plotW,y80); ctx.stroke();
  ctx.setLineDash([]);
}
</script>
</body>
</html>